# machine:
#   pre:
#     - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
#   services:
#     - docker

dependencies:
  pre:
    - if [[ ! -e ~/bin/docker-machine ]]; curl -L https://github.com/docker/machine/releases/download/v0.8.0/docker-machine-`uname -s`-`uname -m` > ~/bin/docker-machine && chmod +x ~/bin/docker-machine; fi
    - if [[ ! -e ~/bin/docker-compose ]]; curl -L https://github.com/docker/compose/releases/download/1.8.0/docker-compose-`uname -s`-`uname -m` > ~/bin/docker-compose && chmod +x ~/bin/docker-compose; fi

  cache_directories:
    - /tmp/docker
    - ~/bin

deployment:
  hub:
    branch: features/docker
    commands:
      - docker --version
      - docker-machine --version
      - docker-compose --version
      - docker-machine --storage-path docker/machine ls
      - export DOCKER_TLS_VERIFY="1"
      - export DOCKER_HOST="tcp://52.20.45.85:2376"
      - export DOCKER_CERT_PATH="docker/machine/machines/app.production"
      - export DOCKER_MACHINE_NAME="app.production"
      - eval $(docker-machine --storage-path docker/machine env app.production)
      - docker-compose --host tcp://52.20.45.85:2376 ps
      - docker-compose ps
      - docker-compose ps
      - bundle exec rake deploy

test:
  override:
    - echo 'Skip'
